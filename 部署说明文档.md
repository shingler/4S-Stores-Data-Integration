# DMS Interface Python Application

当前交付版本：v 0.3



## How to deploy

#### 脚本部署 for windows

1. 安装python环境（推荐3.7版本）[下载链接](https://www.python.org/ftp/python/3.8.6/python-3.8.6rc1-amd64.exe)，并勾选安装界面的“Add Python3.7 to PATH“以配置环境变量。

2. 将代码复制到指定的目录下（例：D:\path\to\code）

3. 用命令行打开代码目录，执行以下命令以安装必须的依赖：

   ```powershell
   pip3 install -r requirements.txt
   ```

4. 代码根目录下，用文本编辑器打开settings.py，修改数据库连接字符串。可以参考Test类的写法，将为Production类赋予SQLALCHEMY_DATABASE_URI变量的值。

   > ```python
   > mssql+pyodbc://sa:msSqlServer2020@127.0.0.1:1401/dms_interface?driver=ODBC+Driver+17+for+SQL+Server
   > # 格式说明：
   > # mssql+pyodbc	使用pyodbc来连接sql server
   > # sa:msSqlServer2020 为连接sql server的用户名和密码
   > # 127.0.0.1:1401	@后面的部分为sql server的主机名（或IP地址），：后面是端口号（默认1433）
   > # dms_interface	/ 后面的是数据库的名字
   > # ?driver=ODBC+Driver+17+for+SQL+Server	这部分是odbc for sqlserver驱动的版本，这里连接的是sql server 2017
   > ```

5. 代码里三处设置了对配置文件settings.py的引用，需要根据场景修改加载不同的配置。这些文件是：

   - bin/\_\_init\_\_.py	        运行脚本
   - src/\_\_init\_\_.py            源码
   - tests/conftest.py         测试用例

   举例：

   ```python
   #bin/__init__.py
   app = Flask(__name__)
   #app.config.from_object("settings.Development")      # 用于开发环境
   #app.config.from_object("settings.Test")             # 用于测试环境
   #app.config.from_object("settings.Production")       # 用于生产环境
   ```

   解开对应环境的注释，并保持加载其他环境语句的注释状态
   
   

#### 接口部署 for windows测试

用命令行打开代码目录，并执行以下命令以启动服务：

```
venv\Scripts\python.exe app.py
```

这个命令行请保持运行状态，关闭窗口则会导致服务关闭。

服务启动的状态下，可以访问：http://127.0.0.1:5000，确保页面出现 It Works! 表示服务启动成功。



## How to use

- 初始化数据库：可通过执行代码根目录下的init_db.py生成数据库结构及测试数据。

  ```shell
  python3 init_db.py
  ```

- 执行单独数据脚本：可运行bin目录下的py文件，以CustVendInfo的数据为例。

  ```shell
  python3 bin\cust_vend.py
  ```



## API

### 接口说明

针对4种数据的访问，提供4个基于HTTP的POST请求接口。

#### Cust Vend Info

接口URL：http://127.0.0.1:5000/cust_vend

请求方法：POST

参数：

| 参数名       | 数据类型 | 备注                                                         |
| ------------ | -------- | ------------------------------------------------------------ |
| company_code | string   | 公司代码，不能为空                                           |
| api_code     | string   | API代码，不能为空                                            |
| api_type     | string   | 1=json api, 2=xml                                            |
| retry        | int      | 是否重试。0=不重试，即用地址1解析;1=重试，即用地址2进行解析。 |
| options      | string   | json格式文本，见下面定义                                     |

- **options定义**

  {"p_code":"value","file_path":"d:\ddd\ddd.xml"}

  - p_code参数主要参考自表DMS\_API\_P\_In的配置，主要包含开始时间、结束时间等。当api_type=1时有效。
  - file_path参数是要解析的xml文件的绝对路径。当api_type=2时有效。默认读取指定的company_code和api_code读取到的文件路径+当天的对应文件的路径。如：D:\DMS_interface\company\YYYYMMDD_custvend.xml

  

- 返回格式：

  ```json
  {
      "entry_no": 7,
      "status": 1
  }
  ```

- 返回参数说明：

| 参数名        | 数据类型 | 备注说明                           |
| ------------- | -------- | ---------------------------------- |
| status        | int      | 状态，1=成功，其他表示失败         |
| error_message | string   | 错误消息，仅status不为1时才有      |
| entry_no      | int      | 数据成功写入的id，仅status=1时才有 |

  

#### FA

接口URL：http://127.0.0.1:5000/fa

接口相关说明同上

#### Invoice

接口URL：http://127.0.0.1:5000/invocie

接口相关说明同上

#### Other

接口URL：http://127.0.0.1:5000/other

接口相关说明同上

### 状态码说明

- 1：成功
- x0000：未知错误，相见错误信息
- x0001：必要字段为空
- x0002：发票信息为空
- x0003：数据读取失败
- x0004：数据读取超时

x的取值范围为1~4，分别对应：1=cust vend, 2=fa, 3=invoice, 4=other