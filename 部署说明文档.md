# DMS Interface Python Application

当前交付版本：v 0.1

## Changelog

#### v 0.2

##### API日志：

- 开始访问接口时新增API日志（**无论访问成功还是失败**），并在数据读取完成后，修改该日志的状态和结果；
  - 对文件读取的日志记录；
  - 对DMS接口读取的日志记录需等到DMS接口就绪；
  - 对NAV接口读取的日志记录需等到NAV接口就绪；

##### 超时：

- 主线程可以根据DMS_API_Setup中规定的超时时间为依据，对读取数据结束后的时间做判断。超过时间可中止线程并发送超时邮件；

##### 任务设置

- 读取时应根据Task_Setup.API_Type来判断。Data_Format仅当做数据处理转换的判断依据。DMS的接口和文件均有可能返回JSON格式或XML格式。
- DMS接口读取完成，更新DMS_Task_Setup.Last_Executed_Time；
- 主线程需要判断任务是否满足开始时间；
- 任务失败处理=3，改为重试一次。再次失败发送报警邮件；

##### 提醒邮件

- 两种场景：（1）DMS接口重试依然报错且失败处理=3；（2）DMS读取超时
- 两种收件人：（1）DMS_Notification_User中相应公司编码的IT人员；（2）User_List中Receive_Notification=1的所有人员；

##### 数据库变动

- API日志增加字段：Status（访问状态），Error_Message（错误信息）和API_Direction（接口访问方向）；

- NAV的6张表将转移到其他库，且表名会修改。可以根据Company_List里的数据库相关字段拼接连接字符串及表名（Company_List.NAV_Company_Code + '\$' + DMS_API_Setup.Table_Name）。

```
	NAV_DB_Name，NAV_DB_Address，NAV_DB_UserID，NAV_DB_Password，NAV_Company_Code
```

##### 供NAV访问的接口

- 数据流向为从DMS到Buffer的接口，参数为Company_Code和API_Code；
- 数据流向为从Buffer到NAV的接口；



#### v 0.1

	- 根据公司数据和api设置对指定目录下的xml进行读取
	- 根据api输出参数设置，将数据保存到对应的数据库中
	- General数据保存在interfaceInfo表，除发票保存在发票抬头和发票明细表中，其他数据都保存在对应的表中。

## How to deploy

#### windows平台

1. 安装python环境（推荐3.7版本）[下载链接](https://www.python.org/ftp/python/3.8.6/python-3.8.6rc1-amd64.exe)，并勾选安装界面的“Add Python3.7 to PATH“以配置环境变量。

2. 将代码复制到指定的目录下（例：D:\path\to\code）

3. 用命令行打开代码目录，执行以下命令以安装必须的依赖：

   ```powershell
   pip3 install -r requirements.txt
   ```

4. 代码根目录下，用文本编辑器打开settings.py，修改数据库连接字符串。可以参考Test类的写法，将为Production类赋予SQLALCHEMY_DATABASE_URI变量的值。

   > ```python
   > mssql+pyodbc://sa:msSqlServer2020@127.0.0.1:1401/dms_interface?driver=ODBC+Driver+17+for+SQL+Server
   > # 格式说明：
   > # mssql+pyodbc	使用pyodbc来连接sql server
   > # sa:msSqlServer2020 为连接sql server的用户名和密码
   > # 127.0.0.1:1401	@后面的部分为sql server的主机名（或IP地址），：后面是端口号（默认1433）
   > # dms_interface	/ 后面的是数据库的名字
   > # ?driver=ODBC+Driver+17+for+SQL+Server	这部分是odbc for sqlserver驱动的版本，这里连接的是sql server 2017
   > ```

5. 代码里三处设置了对配置文件settings.py的引用，需要根据场景修改加载不同的配置。这些文件是：

   - bin/\_\_init\_\_.py	        运行脚本
   - src/\_\_init\_\_.py            源码
   - tests/conftest.py         测试用例

   举例：

   ```python
   #bin/__init__.py
   app = Flask(__name__)
   #app.config.from_object("settings.Development")      # 用于开发环境
   #app.config.from_object("settings.Test")             # 用于测试环境
   #app.config.from_object("settings.Production")       # 用于生产环境
   ```

   解开对应环境的注释，并保持加载其他环境语句的注释状态

## How to use

- 初始化数据库：可通过执行代码根目录下的init_db.py生成数据库结构及测试数据。

  ```shell
  python3 init_db.py
  ```

- 执行单独数据脚本：可运行bin目录下的py文件，以CustVendInfo的数据为例。

  ```shell
  python3 bin\cust_vend.py
  ```